# üõí E-Commerce Backend API

A production-ready e-commerce backend built with Node.js, Express, and MongoDB. Features a complete product catalog, shopping cart management, order processing, and integrated payment gateway (Stripe) with comprehensive authentication and authorization.

## ‚ú® Key Features

- üîê **JWT Authentication** - Secure user authentication with access and refresh tokens
- üõçÔ∏è **Product Management** - Full CRUD operations with categories, search, and filtering
- üõí **Shopping Cart** - Persistent cart with real-time inventory validation
- üì¶ **Order Processing** - Complete order lifecycle with status tracking
- üí≥ **Payment Integration** - Stripe payment processing with webhook support
- üë• **User Management** - Role-based access control (Admin, Seller, Customer)
- üîí **Security** - Helmet, rate limiting, input sanitization, CORS protection
- üìß **Email Notifications** - SendGrid integration for transactional emails
- üìä **Logging** - Winston logger with daily rotation and multiple transports
- üê≥ **Docker Ready** - Complete Docker and Docker Compose configuration
- ‚ö° **Redis Caching** - Optional Redis support for sessions and rate limiting
- üß™ **Testing** - Jest configuration with unit and integration test support

## üìã Prerequisites

- **Node.js**: >= 18.0.0
- **npm**: >= 9.0.0
- **MongoDB**: >= 6.0 (local or Atlas)
- **Redis**: >= 7.0 (optional, for caching)
- **Stripe Account**: For payment processing
- **SendGrid Account**: For email notifications (optional)

## üöÄ Installation

### 1. Clone the Repository

```bash
git clone <repository-url>
cd ecommerce-backend
```

### 2. Install Dependencies

```bash
npm install
```

### 3. Environment Configuration

Copy the example environment file:

```bash
cp .env.example .env
```

Edit `.env` with your configuration (see Environment Variables section below).

### 4. Database Setup

**Option A: Local MongoDB**

```bash
# Start MongoDB service
sudo systemctl start mongodb

# Or using Docker
docker run -d -p 27017:27017 --name mongodb mongo:6.0
```

**Option B: MongoDB Atlas**

1. Create a free cluster at [mongodb.com/cloud/atlas](https://www.mongodb.com/cloud/atlas)
2. Get your connection string
3. Update `MONGODB_URI` in `.env`

### 5. Generate JWT Secrets

```bash
# Generate secure random strings for JWT secrets
node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"
```

Copy the output and use it for `JWT_ACCESS_SECRET` and `JWT_REFRESH_SECRET` in `.env`.

## ‚öôÔ∏è Environment Variables

### Required Variables

| Variable | Description | Example |
|----------|-------------|---------|
| `NODE_ENV` | Environment mode | `development` or `production` |
| `PORT` | Server port | `3000` |
| `MONGODB_URI` | MongoDB connection string | `mongodb://localhost:27017/ecommerce` |
| `JWT_ACCESS_SECRET` | JWT access token secret (min 32 chars) | Generated using crypto |
| `JWT_ACCESS_EXPIRY` | Access token expiration | `15m` |
| `JWT_REFRESH_SECRET` | JWT refresh token secret (min 32 chars) | Generated using crypto |
| `JWT_REFRESH_EXPIRY` | Refresh token expiration | `7d` |
| `SESSION_SECRET` | Express session secret (min 32 chars) | Generated using crypto |
| `STRIPE_SECRET_KEY` | Stripe secret key | `sk_test_...` or `sk_live_...` |
| `STRIPE_PUBLISHABLE_KEY` | Stripe publishable key | `pk_test_...` or `pk_live_...` |
| `STRIPE_WEBHOOK_SECRET` | Stripe webhook signing secret | `whsec_...` |

### Optional Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `HOST` | Server host | `localhost` |
| `API_VERSION` | API version prefix | `v1` |
| `MONGODB_MAX_POOL_SIZE` | MongoDB connection pool size | `10` |
| `BCRYPT_ROUNDS` | Password hashing rounds | `10` |
| `PAYMENT_CURRENCY` | Default payment currency | `USD` |
| `CLIENT_URL` | Frontend application URL | `http://localhost:3000` |
| `CORS_ORIGIN` | Allowed CORS origins (comma-separated) | `http://localhost:3000` |
| `RATE_LIMIT_WINDOW_MS` | Rate limit window in ms | `900000` (15 min) |
| `RATE_LIMIT_MAX_REQUESTS` | Max requests per window | `100` |
| `LOG_LEVEL` | Logging level | `info` |
| `LOG_FILE_PATH` | Log directory path | `./logs` |

### Email Configuration (Optional)

| Variable | Description | Example |
|----------|-------------|---------|
| `EMAIL_SERVICE` | Email service provider | `smtp` or `sendgrid` |
| `EMAIL_HOST` | SMTP host | `smtp.gmail.com` |
| `EMAIL_PORT` | SMTP port | `587` |
| `EMAIL_SECURE` | Use TLS | `false` |
| `EMAIL_USER` | Email username | `your-email@example.com` |
| `EMAIL_PASSWORD` | Email password/app password | Your password |
| `EMAIL_FROM` | Sender email address | `noreply@ecommerce.com` |
| `EMAIL_FROM_NAME` | Sender name | `E-Commerce Store` |
| `SENDGRID_API_KEY` | SendGrid API key (if using SendGrid) | `SG.xxx` |

### Redis Configuration (Optional)

| Variable | Description | Default |
|----------|-------------|---------|
| `REDIS_HOST` | Redis server host | `localhost` |
| `REDIS_PORT` | Redis server port | `6379` |
| `REDIS_PASSWORD` | Redis password | (empty) |
| `REDIS_DB` | Redis database number | `0` |
| `CACHE_TTL` | Cache TTL in seconds | `3600` |

### File Upload Configuration

| Variable | Description | Default |
|----------|-------------|---------|
| `MAX_FILE_SIZE` | Max file size in bytes | `5242880` (5MB) |
| `UPLOAD_PATH` | Upload directory | `./uploads` |
| `ALLOWED_FILE_TYPES` | Allowed MIME types | `image/jpeg,image/png,image/webp,image/gif` |

## üèÉ How to Run

### Development Mode

```bash
npm run dev
```

Starts the server with nodemon for auto-reloading on file changes.

### Production Mode

```bash
npm start
```

Starts the server without auto-reloading.

### Run Tests

```bash
# Run all tests with coverage
npm test

# Run tests in watch mode
npm run test:watch
```

### Linting

```bash
# Check for linting errors
npm run lint

# Fix linting errors automatically
npm run lint:fix
```

### Code Formatting

```bash
npm run format
```

### Database Seeding

```bash
npm run seed
```

### Using Docker

```bash
# Start all services (API, MongoDB, Redis, Admin UIs)
docker-compose up -d

# View logs
docker-compose logs -f api

# Stop all services
docker-compose down

# Stop and remove volumes
docker-compose down -v
```

**Docker Services:**
- API: `http://localhost:3000`
- MongoDB: `localhost:27017`
- Redis: `localhost:6379`
- Mongo Express (DB UI): `http://localhost:8081` (admin/admin123)
- Redis Commander: `http://localhost:8082` (admin/admin123)

## üì° API Endpoints

### Authentication

| Method | Endpoint | Description | Auth Required |
|--------|----------|-------------|---------------|
| POST | `/api/auth/register` | Register new user | ‚ùå |
| POST | `/api/auth/login` | Login user | ‚ùå |
| POST | `/api/auth/refresh` | Refresh access token | ‚ùå |
| POST | `/api/auth/logout` | Logout current session | ‚úÖ |
| POST | `/api/auth/logout-all` | Logout all sessions | ‚úÖ |
| POST | `/api/auth/forgot-password` | Request password reset | ‚ùå |
| POST | `/api/auth/reset-password` | Reset password with token | ‚ùå |

### Products

| Method | Endpoint | Description | Auth Required |
|--------|----------|-------------|---------------|
| GET | `/api/products` | Get all products (paginated) | ‚ùå |
| GET | `/api/products/:id` | Get product by ID | ‚ùå |
| GET | `/api/products/search` | Search products | ‚ùå |
| POST | `/api/products` | Create new product | ‚úÖ Admin |
| PUT | `/api/products/:id` | Update product | ‚úÖ Admin |
| DELETE | `/api/products/:id` | Delete product (soft delete) | ‚úÖ Admin |

### Categories

| Method | Endpoint | Description | Auth Required |
|--------|----------|-------------|---------------|
| GET | `/api/categories` | Get all categories | ‚ùå |
| GET | `/api/categories/:id` | Get category by ID | ‚ùå |
| GET | `/api/categories/:id/subcategories` | Get subcategories | ‚ùå |
| GET | `/api/categories/tree` | Get category tree | ‚ùå |
| POST | `/api/categories` | Create category | ‚úÖ Admin |
| PUT | `/api/categories/:id` | Update category | ‚úÖ Admin |
| DELETE | `/api/categories/:id` | Delete category | ‚úÖ Admin |

### Shopping Cart

| Method | Endpoint | Description | Auth Required |
|--------|----------|-------------|---------------|
| GET | `/api/cart` | Get user's cart | ‚úÖ |
| POST | `/api/cart/items` | Add item to cart | ‚úÖ |
| PUT | `/api/cart/items/:productId` | Update cart item quantity | ‚úÖ |
| DELETE | `/api/cart/items/:productId` | Remove item from cart | ‚úÖ |
| DELETE | `/api/cart` | Clear entire cart | ‚úÖ |

### Orders

| Method | Endpoint | Description | Auth Required |
|--------|----------|-------------|---------------|
| GET | `/api/orders` | Get user's orders | ‚úÖ |
| GET | `/api/orders/:id` | Get order by ID | ‚úÖ |
| POST | `/api/orders` | Create new order | ‚úÖ |
| POST | `/api/orders/:id/cancel` | Cancel order | ‚úÖ |
| PATCH | `/api/orders/:id/status` | Update order status | ‚úÖ Admin |
| POST | `/api/orders/:id/refund` | Refund order | ‚úÖ Admin |

### Payments

| Method | Endpoint | Description | Auth Required |
|--------|----------|-------------|---------------|
| POST | `/api/payments/intent` | Create payment intent | ‚úÖ |
| POST | `/api/payments/webhook` | Stripe webhook handler | ‚ùå |
| POST | `/api/payments/refund` | Process refund | ‚úÖ |
| GET | `/api/payments/status/:orderId` | Get payment status | ‚úÖ |
| GET | `/api/payments/methods` | Get user payment methods | ‚úÖ |
| POST | `/api/payments/methods` | Add payment method | ‚úÖ |
| DELETE | `/api/payments/methods/:methodId` | Delete payment method | ‚úÖ |

### Users

| Method | Endpoint | Description | Auth Required |
|--------|----------|-------------|---------------|
| GET | `/api/users` | Get all users | ‚úÖ Admin |
| GET | `/api/users/:id` | Get user by ID | ‚úÖ Admin |
| GET | `/api/users/profile` | Get own profile | ‚úÖ |
| PUT | `/api/users/profile` | Update own profile | ‚úÖ |
| PUT | `/api/users/change-password` | Change password | ‚úÖ |
| POST | `/api/users` | Create user | ‚úÖ Admin |
| PUT | `/api/users/:id` | Update user | ‚úÖ Admin |
| DELETE | `/api/users/:id` | Delete user | ‚úÖ Admin |
| PATCH | `/api/users/:id/status` | Update user status | ‚úÖ Admin |

### Health Check

| Method | Endpoint | Description | Auth Required |
|--------|----------|-------------|---------------|
| GET | `/health` | API health status | ‚ùå |

## üèóÔ∏è Architecture Overview

### Project Structure

```
src/
‚îú‚îÄ‚îÄ config/              # Configuration files
‚îÇ   ‚îú‚îÄ‚îÄ database.js      # MongoDB connection with retry logic
‚îÇ   ‚îú‚îÄ‚îÄ environment.js   # Environment variable validation
‚îÇ   ‚îú‚îÄ‚îÄ logger.js        # Winston logger configuration
‚îÇ   ‚îú‚îÄ‚îÄ stripe.js        # Stripe payment gateway setup
‚îÇ   ‚îú‚îÄ‚îÄ sendgrid.js      # SendGrid email service
‚îÇ   ‚îú‚îÄ‚îÄ redis.js         # Redis client configuration
‚îÇ   ‚îú‚îÄ‚îÄ cloudinary.js    # Cloudinary image storage
‚îÇ   ‚îî‚îÄ‚îÄ paypal.js        # PayPal SDK configuration
‚îú‚îÄ‚îÄ controllers/         # Request handlers
‚îÇ   ‚îú‚îÄ‚îÄ auth.controller.js
‚îÇ   ‚îú‚îÄ‚îÄ cart.controller.js
‚îÇ   ‚îú‚îÄ‚îÄ category.controller.js
‚îÇ   ‚îú‚îÄ‚îÄ order.controller.js
‚îÇ   ‚îú‚îÄ‚îÄ payment.controller.js
‚îÇ   ‚îú‚îÄ‚îÄ product.controller.js
‚îÇ   ‚îî‚îÄ‚îÄ user.controller.js
‚îú‚îÄ‚îÄ middleware/          # Express middleware
‚îÇ   ‚îú‚îÄ‚îÄ auth.js          # JWT authentication
‚îÇ   ‚îú‚îÄ‚îÄ authorization.js # Role-based access control
‚îÇ   ‚îú‚îÄ‚îÄ cors.js          # CORS configuration
‚îÇ   ‚îú‚îÄ‚îÄ errorHandler.js  # Global error handling
‚îÇ   ‚îú‚îÄ‚îÄ logger.js        # Request logging
‚îÇ   ‚îú‚îÄ‚îÄ rateLimiter.js   # Rate limiting
‚îÇ   ‚îî‚îÄ‚îÄ validation.js    # Request validation
‚îú‚îÄ‚îÄ models/              # Mongoose schemas
‚îÇ   ‚îú‚îÄ‚îÄ User.js          # User account schema
‚îÇ   ‚îú‚îÄ‚îÄ Product.js       # Product catalog schema
‚îÇ   ‚îú‚îÄ‚îÄ Category.js      # Product category schema
‚îÇ   ‚îú‚îÄ‚îÄ Cart.js          # Shopping cart schema
‚îÇ   ‚îú‚îÄ‚îÄ Order.js         # Order schema
‚îÇ   ‚îú‚îÄ‚îÄ OrderItem.js     # Order line item schema
‚îÇ   ‚îî‚îÄ‚îÄ Payment.js       # Payment transaction schema
‚îú‚îÄ‚îÄ routes/              # API route definitions
‚îÇ   ‚îú‚îÄ‚îÄ auth.routes.js
‚îÇ   ‚îú‚îÄ‚îÄ cart.routes.js
‚îÇ   ‚îú‚îÄ‚îÄ category.routes.js
‚îÇ   ‚îú‚îÄ‚îÄ order.routes.js
‚îÇ   ‚îú‚îÄ‚îÄ payment.routes.js
‚îÇ   ‚îú‚îÄ‚îÄ product.routes.js
‚îÇ   ‚îú‚îÄ‚îÄ user.routes.js
‚îÇ   ‚îî‚îÄ‚îÄ index.js         # Route aggregator
‚îú‚îÄ‚îÄ services/            # Business logic layer
‚îÇ   ‚îú‚îÄ‚îÄ auth.service.js
‚îÇ   ‚îú‚îÄ‚îÄ cart.service.js
‚îÇ   ‚îú‚îÄ‚îÄ category.service.js
‚îÇ   ‚îú‚îÄ‚îÄ email.service.js
‚îÇ   ‚îú‚îÄ‚îÄ order.service.js
‚îÇ   ‚îú‚îÄ‚îÄ payment.service.js
‚îÇ   ‚îú‚îÄ‚îÄ product.service.js
‚îÇ   ‚îî‚îÄ‚îÄ user.service.js
‚îú‚îÄ‚îÄ utils/               # Utility functions
‚îÇ   ‚îú‚îÄ‚îÄ validators.js    # Input validation helpers
‚îÇ   ‚îú‚îÄ‚îÄ helpers.js       # General helper functions
‚îÇ   ‚îú‚îÄ‚îÄ logger.js        # Logger utility
‚îÇ   ‚îú‚îÄ‚îÄ response.js      # API response formatter
‚îÇ   ‚îî‚îÄ‚îÄ jwt.js           # JWT token utilities
‚îú‚îÄ‚îÄ app.js               # Express application setup
‚îî‚îÄ‚îÄ server.js            # Server entry point
```

### Technology Stack

- **Runtime**: Node.js 